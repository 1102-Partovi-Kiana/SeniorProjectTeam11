{% extends "base.html" %}

{% block title %}
<title>Robotic Environment - Fetch Reach - CORE</title>
{% endblock %}

{% block body %}
<section class="robotic-environment">
    <!-- Preload Pets -->
    <div style="display: none;">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_run_8fps.gif') }}" alt="Run">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_swipe_8fps.gif') }}" alt="Swipe">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_walk_8fps.gif') }}" alt="Walk1">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_walk_fast_8fps.gif') }}" alt="Walk2">
    </div>
    <div class="container-fluid content-background">
        <div class="row" style="min-height: 100vh; padding-top: 10px;">
            <!-- Coding Area and Simulation Side by Side -->
            <div class="col-md-6 d-flex flex-column">
                <div class="code-editor h-100">
                     <!-- Tab Buttons Above the Coding Area -->
                     <div class="coding-options">
                        
                        <div class="dropdown-container">
                            <button class="tab-button" id="coding-pets" data-tippy-content="Enable Coding Pets">
                                <i class="fas fa-paw"></i> 
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" class="dropdown-item pet-option" pet-type="chicken">Chicken</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="dog">Dog</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="turtle">Turtle</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="snail">Snail</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="snake">Snake</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="rubberduck">Rubber Duck</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="rock">Rock</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="rat">Rat</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="horse">Horse</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="fox">Fox</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="crab">Crab</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="bird">Bird</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="unicorn">Unicorn</a></li>
                                <li><a href="#" class="dropdown-item pet-option" pet-type="dinosaur">Dinosaur</a></li>
                                <li><a href="#" id="disable-pet" class="dropdown-item" style="display: none;">Disable Pet</a></li>
                            </ul>
                        </div>
                        <button class="tab-button" id="light-mode" data-tippy-content="Switch to Light Mode">
                            <i class="fas fa-sun"></i> 
                        </button>
                        <div class="dropdown-container">
                            <button class="tab-button" id="syntax-highlight" data-tippy-content="Change Syntax Highlighting Color">
                                <i class="fas fa-palette"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" class="dropdown-item theme-option" data-theme="monokai">Monokai</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="dracula">Dracula</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="material">Material</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="ambiance">Ambiance</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="cobalt">Cobalt</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="twilight">Twilight</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="solarized dark">Solarized Dark</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="midnight">Midnight</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="lucario">Lucario</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="seti">Seti</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="blackboard">Blackboard</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="zenburn">Zenburn</a></li>
                            </ul>
                        </div>
                       
                        <!-- <button class="tab-button" id="dark-mode-pop-up-window" data-tippy-content="Switch the Pop Up Window to Dark Mode">
                            <i class="fas fa-adjust"></i> 
                        </button> -->

                        <button class="tab-button" id="review-course-content" data-tippy-content="Review Course Content">
                            <i class="fas fa-book"></i> 
                        </button>

                        <button class="tab-button" id="autocomplete" data-tippy-content="Enable Autocomplete">
                            <i class="fas fa-magic"></i> 
                        </button>
            
                        <!-- Hints Container
                        <div class="dropdown-container">
                            <button class="tab-button" id="hints-button" data-tippy-content="Your Personalized Hints">
                                <i class="fas fa-lightbulb"></i> 
                            </button>
                            <div class="hintbox-container" id="hintbox-container" style="display: none;">
                                <h4>Hints</h4>
                                <ul id="hintbox" class="hintbox"></ul>
                            </div>
                        </div> -->
                        <!-- Hint Button with Dropdown -->
                        <div class="dropdown-container" style="display: none;">
                            <button class="tab-button" id="hints-button" data-tippy-content="Personalized Hints">
                                <i class="fas fa-lightbulb"></i>
                            </button>
                            <ul class="dropdown-menu" id="hints-dropdown" style="display: none;">
                                <li><button class="dropdown-item" data-hint="1">Get Hint 1</button></li>
                                <li><button class="dropdown-item" data-hint="2">Get Hint 2</button></li>
                                <li><button class="dropdown-item" data-hint="3">Get Hint 3</button></li>
                            </ul>
                        </div>

                        <!-- Hint Box -->
                        <div class="hintbox-container" id="hintbox-container" style="display: none;">
                            <h4 style="display: none">Hints</h4>
                            <ul id="hintbox" class="hintbox" style="display: none"></ul>
                        </div>

                        <div class="robot-description text-coding-options ">
                            <p>The Fetch Sensors Robot: Utilize the robot's sensors to guide the gripper in transporting all objects to the container.</p>
                            <br>
                        </div>

                        <!-- Robot Description -->

                    </div>
                    <!-- Darren's Code -->                    
                    <div class="card-header">Coding Area</div>
                    <textarea id="code-editor" rows="20" style="height: 100%;">
# Fetch Sensors Robot Task: Use sensor data to detect four objects within the environment and move them to the container

# Given: Actions for the robot
close_grip_action = np.array([0, 0, 0, -1])
open_grip_action = np.array([0, 0, 0, 1])

# Given: Container position location 
container_position = np.array([1.3, 0.3, 0.54])

# Given: The distance threshold (stop condition) for reaching the target position (the container)
object_to_container_threshold = 0.03  # Threshold for object proximity to container

# Given: The for loop moving 50 steps before executing the main logic
for _ in range (50):
    # Given: Move the robot arm downward (Z-axis)
    env.step([0,0,-.1,1])

# Given: Main loop for moving and detecting objects using sensors
for _ in range(150):
    # TODO: Move the robot arm slightly left (Y-axis)
    env.step([0,-0.1,0,0])
    
    # TODO: Read the front sensor value of the robot from the environment and store it in a variable
    forward = env.get_sensor_forward_value()

    # Given: Threshold for detecting an object in front on the sensor
    SENSOR_THRESHOLD = 0.5  

    # Given: Check if an object is detected in front of the sensor
    if forward < SENSOR_THRESHOLD:
        print("Object Detected")
        
        # Given: Store the initial gripper position to return to after placing the object
        previous_gripper_position = np.copy(env.sim.data.get_site_xpos('robot0:grip'))
        
        # Given: Move forward until the object is very close
        while forward > 0.01:
            # TODO: Read the front sensor value of the robot from the environment and store it in a variable
            forward = env.get_sensor_forward_value()
            # Given: Move forward slowly
            env.step([0.1,0,0,0])
            
        # Given: The for loop preparing to open the gripper for picking up the object
        for _ in range (40):
            # TODO: Apply the open grip action to the environment
            env.step(open_grip_action)
            
        # Given: The for loop for moving the gripper upwards before grasping the object
        for _ in range(40):
            # Given: Define the ascend action for moving the arm upward (Z-axis)
            ascend_action = np.array([0, 0, 0.13, 0])
            # TODO: Apply the ascend action to the environment
            env.step(ascend_action)
            
        # Given: The for loop for moving forward to align with the object
        for _ in range (40):
            # Given: Move the robot forward at a small step size along the X-axis
            env.step([0.1,0,0,0])
            
        # Given: The for loop for moving the gripper down to grasp the object
        for _ in range(40):
            # Given: Move down along the Z-axis
            descend_action = np.array([0, 0, -0.13, 0])
            # TODO: Apply the descend action to the environment
            env.step(descend_action)

        # Given: The for loop for closing the gripper to grab the object
        for _ in range(40):
            # TODO: Apply the close grip action to the environment
            env.step(close_grip_action)
        
        # Given: The for loop for lifting the object after gripping it
        for _ in range(40):
            # Given: Define the ascend action for moving the arm upward (Z-axis)
            ascend_action = np.array([0, 0, 0.13, 0])
            # TODO: Apply the close grip action to the environment
            env.step(close_grip_action)
            # TODO: Apply the ascend action to the environment
            env.step(ascend_action)
        
        # Given: The for loop for moving the object to the container location

        for _ in range(100):
            # TODO: Get the gripper position from the environment and store it in a variable
            gripper_position = env.sim.data.get_site_xpos('robot0:grip')
            
            # TODO: Apply the close grip action to the environment
            env.step(close_grip_action)
            
            # TODO: Calculate the distance from the current gripper position to the container
            distance_to_container = np.array(container_position) - np.array(gripper_position)
            
            # TODO: Calculate the Euclidean distance (magnitude of the vector) between the gripper and the container
            distance_to_container_magnitude = np.linalg.norm(distance_to_container)

            # Given: Check if the object is within the specified proximity threshold to the container
            # If the object is close enough, stop moving towards the container
            if distance_to_container_magnitude <= object_to_container_threshold:
                break # Exit the loop, as the object has reached the target position
            
            # TODO: Normalize the distance to the container
            distance_to_container_normalized = distance_to_container / (distance_to_container_magnitude + 1e-8)

            # Given: Define the movement action to move towards the container
            move_to_container_action = np.array([
                distance_to_container_normalized[0] * 0.5, # Move in X direction towards the container
                distance_to_container_normalized[1] * 0.5, # Move in Y direction towards the container
                0, # Keep the Z-axis movement fixed
                0  # Keep the gripper state unchanged
            ])
            
            # TODO: Apply the movement action to the environment
            env.step(move_to_container_action)

        # Given: The for loop to open the gripper to release the object in the container
        for _ in range (10):
            # TODO: Apply the open grip action to the environment
            env.step(open_grip_action)

        for _ in range(100):
            # TODO: Get the gripper position from the environment and store it in a variable
            gripper_position = env.sim.data.get_site_xpos('robot0:grip')

            # TODO: Calculate the distance vector from the current gripper position to the previous gripper position
            distance_to_previous = np.array(previous_gripper_position) - np.array(gripper_position)
            
            # TODO: Get the distance (magnitude) to determine how far the robot needs to move back
            distance_to_previous_magnitude = np.linalg.norm(distance_to_previous)

            # TODO: Normalize the direction for smooth movement (add small value (1e-8) to prevent division by zero)
            distance_to_previous_normalized = distance_to_previous / (np.linalg.norm(distance_to_previous_magnitude) + 1e-8)

            # Given: Define the action to move step-by-step back to the previous position
            return_to_previous_action = np.array([
                distance_to_previous_normalized[0] * 0.5, # Move in X direction
                distance_to_previous_normalized[1] * 0.5, # Move in Y direction
                0, # No vertical movement
                0  # No gripper action
            ])
            
            # TODO: Apply the return to the environment
            env.step(return_to_previous_action)
            
        # Given: The for loop to slightly lower the robot arm after returning
        for _ in range (50):
            # Given: Lower the robot arm along the Z-axis
            env.step([0,0,-0.1,0])  
            
    # Given: Otherwise no object was detected
    else:
        print("No Object")  
                    </textarea>
                    <div class="row align-items-center">
                        <!-- Output Box -->
                        <div class="col-md-8">
                          <div id="secondary-output-box" class="secondary-output-card secondary-output-hidden">
                            <!-- This box will display the same errors as the primary output box -->
                          </div>
                        </div>
                      
                        <!-- Run Button -->
                        <div class="col-md-4 d-flex justify-content-end run-button-container">
                          <button id="run-code" class="run-button">Run</button>
                        </div>
                      </div>
                      
                    <!-- Popup Window -->           
                    <div id="popup-window" class="modal">
                        <div class="modal-header">
                            <div>Output Window</div>
                            <div class="actions">
                                <button id="minimize-popup">_</button>
                                <button id="maximize-popup" style="display: none;">⤢</button>
                                <button id="close-popup">&times;</button>
                            </div>
                        </div>
                        <div class="modal-content">
                            <!-- Tab Navigation -->
                            <div id="popup-window-tabs" class="popup-window-tabs">
                                <button class="popup-window-tab active" data-tab="popup-window-compilation-results">Compilation Results</button>
                                <button class="popup-window-tab" data-tab="popup-window-additional-tab">Hints</button>
                                <button class="popup-window-tab" data-tab="popup-window-review-course-content">Review Course Content</button>
                            </div>

                            <!-- Tab Contents -->
                            <div id="popup-window-compilation-results" class="popup-window-tab-content active">
                                <p id="popup-message">This is a test message!</p>
                            </div>
                            <div id="popup-window-additional-tab" class="popup-window-tab-content">
                                <button id="clear-hints-history" class="clear-hints-button" style="margin-bottom: 10px;">Clear Hints History</button>
                                <div id="hints-history-content">
                                    <p>No specific hints available.</p>
                                </div>
                            </div>
                            <div id="popup-window-review-course-content" class="popup-window-tab-content">
                                <h3>Review Course Content</h3>
                                <iframe id="course-content-frame" src="/embedded-course-content" width="100%" height="500px" style="border: none;"></iframe>
                            </div>                            
                        </div>
                    </div>


                    <!-- Ball and Gripper Position -->
                    <!-- <div class="row align-items-start" style="margin-top: 5px;">
                        <div class="col-md-8">
                            <h5>Ball Position:</h5>
                            <p id="ball-position">X: --, Y: --, Z: --</p>
                            <h5>Gripper Position:</h5>
                            <p id="gripper-position">X: --, Y: --, Z: --</p>
                        </div>
                    </div>

                    Collision Notification -->
                    <!-- <div id="collision-notification" class="alert alert-success" style="margin-top: 5px; display: none;">
                        Collision detected between the gripper and the ball!
                    </div> -->

  
                </div>
            </div>
            <!-- End of Darren's Code -->
            
            <!-- <div class="chatbot-container">
                <div id="chatbox" class="chatbox"></div>
                <div class="chat-input-container">
                    <input type="text" id="userInput" placeholder="Type a message">
                    <button id="sendBtn">Send</button>
                </div>
            </div> -->
            
            <!-- <div class="col-md-6 d-flex flex-column">
                <div class="card simulation-card">
                    <div class="card-header">Simulation</div>
                    <div class="simulation-video-container">
                        <img src="{{ url_for('video_feed') }}" class="simulation-video">
                    </div>
                </div>
            </div> -->

             <div class="col-md-6 d-flex flex-column">
                <div class="card simulation-card h-80">
                    <div class="card-header">Simulation</div>
                    <div class="d-flex justify-content-center align-items-center">
                        <img src="{{ url_for('video_feed') }}" width="100%" class="simulation-video">
                    </div>
                </div>
            
                

                <!-- Output Terminal - Placed Below Simulation -->
                <!-- <div class="card output-card">
                    <div class="card-header">Output Terminal</div>
                    <div class="card-body" id="output-box">
                        Output will appear here -->
                    <!-- </div>
                </div> -->
                <div class="card output-card robotic-environment" style="display: none;">
                    <div class="card-header">Output Terminal</div>
                    <div class="card-body">
                        <!-- Tab Navigation -->
                        <!-- <div class="output-tabs">
                            <button class="output-tab-button active" data-tab="output-box">Compilation Results</button>
                        </div> -->
                
                        <!-- Tab Content -->
                        <div class="output-tab-content">
                            <div id="output-box" class="output-tab-pane active">
                                <p>This is where the current output will appear.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <div id="core-certificate-popup" class="core-cert-popup core-cert-popup-hidden">
        <button class="core-cert-close" id="core-cert-close-button">&times;</button>
        <h2 class="core-cert-title">SUCCESS</h2>
        <p class="core-cert-message">YAY GOOD JOB!</p>
        <a href="{{ url_for('module_ten_certificate_organize_sensors') }}" class="core-cert-button" target="_blank">Get My Certificate</a>
    </div>

</section>

<!-- CodeMirror and Script Initialization -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css" rel="stylesheet">
<!-- Dracula Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css" rel="stylesheet">

<!-- Material Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material.min.css" rel="stylesheet">

<!-- Ambiance Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ambiance.min.css" rel="stylesheet">

<!-- Cobalt Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/cobalt.min.css" rel="stylesheet">

<!-- Twilight Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/twilight.min.css" rel="stylesheet">

<!-- Solarized Dark Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/solarized.min.css" rel="stylesheet">

<!-- Midnight Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/midnight.min.css" rel="stylesheet">

<!-- Lucario Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/lucario.min.css" rel="stylesheet">

<!-- Tomorrow Night Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/tomorrow-night.min.css" rel="stylesheet">

<!-- Seti Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/seti.min.css" rel="stylesheet">

<!-- Blackboard Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/blackboard.min.css" rel="stylesheet">

<!-- Zenburn Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/zenburn.min.css" rel="stylesheet">

<!-- Solarized Light Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/solarized.min.css" rel="stylesheet">

<!-- Eclipse Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/eclipse.min.css" rel="stylesheet">

<!-- Base16 Light Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/base16-light.min.css" rel="stylesheet">

<!-- XQ Light Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/xq-light.min.css" rel="stylesheet">

<!-- Idea Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/idea.min.css" rel="stylesheet">

<!-- Neo Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/neo.min.css" rel="stylesheet">

<!-- MDN Like Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/mdn-like.min.css" rel="stylesheet">

<!-- Ambiance Mobile Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ambiance-mobile.min.css" rel="stylesheet">

<!-- Parchment Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/parchment.min.css" rel="stylesheet">

<!-- Elegant Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/elegant.min.css" rel="stylesheet">

<!-- 3024 Day Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/3024-day.min.css" rel="stylesheet">


<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script>
    let currentTheme = "monokai"; 
    let isAutocompleteEnabled = false; 

    // Initialize CodeMirror
    const codeEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        lineNumbers: true,
        mode: "python",
        theme: currentTheme,
        tabSize: 4,
        indentUnit: 4,
        autoCloseBrackets: true,
        viewportMargin: Infinity
    });

    const MIN_LINE_COUNT = 100;
    function ensureMinLines() {
        const lineCount = codeEditor.lineCount();
        for (let i = lineCount; i < MIN_LINE_COUNT; i++) {
            codeEditor.replaceRange("\n", CodeMirror.Pos(i));
        }
    }
    ensureMinLines();

    codeEditor.setSize("100%", "calc(80vh - 100px)");

    // AUTOCOMPLETE
    function inputReadHandler(editor, change) {
        if (change.text[0] !== " ") {
            console.log("Input detected:", change.text[0]);
            editor.showHint({ hint: CodeMirror.hint.python });
        }
    }

    async function enableAutocomplete() {
        console.log("Enabling autocomplete...");

        CodeMirror.registerHelper("hint", "python", async function (editor) {
            const cursor = editor.getCursor();
            const code = editor.getValue();
            const line = cursor.line + 1; 
            const column = cursor.ch;

            try {
                const response = await fetch('/get-suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code, line, column }),
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch suggestions');
                }

                const suggestions = await response.json();
                console.log("Combined Suggestions:", suggestions);

                const token = editor.getTokenAt(cursor);
                const word = token.string;
                const start = token.start;
                const end = token.end;

                const filteredSuggestions = suggestions.filter(keyword =>
                    keyword.startsWith(word)
                );

                return {
                    list: filteredSuggestions,
                    from: CodeMirror.Pos(cursor.line, start),
                    to: CodeMirror.Pos(cursor.line, end),
                };
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                return {
                    list: [],
                    from: CodeMirror.Pos(cursor.line, cursor.ch),
                    to: CodeMirror.Pos(cursor.line, cursor.ch),
                };
            }
        });

        codeEditor.setOption("extraKeys", {
            "Ctrl-Space": "autocomplete"
        });

        codeEditor.on("inputRead", inputReadHandler);

        alert("Autocomplete enabled!");
    }

    function disableAutocomplete() {
        console.log("Disabling autocomplete...");
        
        codeEditor.setOption("extraKeys", {});
        codeEditor.off("inputRead", inputReadHandler);

        alert("Autocomplete disabled!");
    }

    document.getElementById("autocomplete").addEventListener("click", function() {
        if (!isAutocompleteEnabled) {
            enableAutocomplete();
        } else {
            disableAutocomplete();
        }
        isAutocompleteEnabled = !isAutocompleteEnabled; // Toggle the flag
    });

    function updatePositions() {
        fetch('/get-ball-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ball-position').textContent = 
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
        fetch('/get-gripper-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('gripper-position').textContent = 
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
    }

    function checkCollision() {
        fetch('/check-collision')
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('collision-notification');
                if (data.collision) {
                    notification.style.display = 'block';
                } else {
                    notification.style.display = 'none';
                }
            })
            .catch(error => console.error('Error checking collision:', error));
    }

let hintsHistory = [];

function clearAllErrorHighlights() {
  codeEditor.operation(() => {
    for (let i = 0; i < codeEditor.lineCount(); i++) {
      codeEditor.removeLineClass(i, 'background', 'error-line');
    }
  });
}

function highlightErrorLine(lineIndex) {
  if (lineIndex >= 0 && lineIndex < codeEditor.lineCount()) {
    codeEditor.addLineClass(lineIndex, 'background', 'error-line');
  }
}

function highlightErrorLineStaticIssue(lineIndex) {
  if (lineIndex >= 0 && lineIndex < codeEditor.lineCount()) {
    codeEditor.addLineClass(lineIndex, 'background', 'static-issue-line');
  }
}

function extractLineNumberFromError(errorMessage) {
  const match = errorMessage.match(/line\s+(\d+)/);
  if (match && match[1]) {
    return parseInt(match[1], 10); // parse that substring as an integer
  }
  return null; 
}

// Popup Logic
const popupWindow = document.getElementById('popup-window');
const popupMessage = document.getElementById('popup-message');
const minimizePopup = document.getElementById('minimize-popup');
const maximizePopup = document.getElementById('maximize-popup');
const closePopup = document.getElementById('close-popup');

// Tab functionality for popup window
const popupWindowTabs = document.querySelectorAll('.popup-window-tab');
const popupWindowTabContents = document.querySelectorAll('.popup-window-tab-content');

popupWindowTabs.forEach(tab => {
    tab.addEventListener('click', () => {
        // Remove 'active' class from all tabs and contents
        popupWindowTabs.forEach(tab => tab.classList.remove('active'));
        popupWindowTabContents.forEach(content => content.classList.remove('active'));

        // Add 'active' class to clicked tab and its content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
    });
});


function showPopup(message, isError = false, activeTab = "popup-window-compilation-results") {
    popupMessage.innerHTML = message;

    // Apply styles based on success or error
    popupWindow.style.borderTop = isError ? '4px solid red' : '4px solid green';

    // Hide popup first before modifying tabs
    popupWindow.style.display = 'none';

    // Remove 'active' class from all tabs and contents
    document.querySelectorAll('.popup-window-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.popup-window-tab-content').forEach(content => content.classList.remove('active'));

    // Set the specified tab as active
    document.querySelector(`[data-tab="${activeTab}"]`).classList.add('active');
    document.getElementById(activeTab).classList.add('active');

    // Now show the popup after setting the correct tab
    setTimeout(() => {
        popupWindow.style.display = 'block';
        popupWindow.classList.add('maximized');
        popupWindow.classList.remove('minimized');
        popupWindow.style.transform = 'translateY(0)';
    }, 10);

    maximizePopup.style.display = 'none';
    minimizePopup.style.display = 'inline-block';
}

document.getElementById("review-course-content").addEventListener("click", function () {
    const popupWindow = document.getElementById("popup-window");
    const tooltipButton = this;

    if (popupWindow.style.display === "block") {
        popupWindow.style.transform = "translateY(100%)"; 
        setTimeout(() => {
            popupWindow.style.display = "none";
        }, 600);
    
        if (tooltipButton._tippy) {
            tooltipButton._tippy.setContent("Review Course Content");
        }
    } else {
        // Open popup directly to "Review Course Content" tab
        showPopup("Reviewing course content...", false, "popup-window-review-course-content");

        if (tooltipButton._tippy) {
            tooltipButton._tippy.setContent("Disable Course Content");
        }
    }
});


document.getElementById("review-course-content").addEventListener("click", () => {
    showPopup("Reviewing course content...");

    document.querySelectorAll('.popup-window-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.popup-window-tab-content').forEach(content => content.classList.remove('active'));

    document.querySelector('[data-tab="popup-window-review-course-content"]').classList.add('active');
    document.getElementById('popup-window-review-course-content').classList.add('active');
});


// Close the popup
closePopup.addEventListener('click', () => {
    popupWindow.style.transform = 'translateY(100%)'; // Slide down
    setTimeout(() => {
        popupWindow.style.display = 'none';
    }, 600); // Match the transition duration
});

minimizePopup.addEventListener('click', () => {
        popupWindow.style.height = 'auto';
        popupWindow.style.bottom = '0';

        requestAnimationFrame(() => {
            popupWindow.style.transform = 'translateY(50%)';
        });

        popupWindow.classList.add('minimized');
        popupWindow.classList.remove('maximized');
        minimizePopup.style.display = 'none';
        maximizePopup.style.display = 'inline-block';
});

// Maximize the popup (to the full height)
maximizePopup.addEventListener('click', () => {
    popupWindow.classList.remove('minimized');
    popupWindow.classList.add('maximized');
    maximizePopup.style.display = 'none';
    minimizePopup.style.display = 'inline-block';

    // Expand height to full and remain at the bottom
    popupWindow.style.height = '100%'; // Expand to full height
    popupWindow.style.bottom = '0'; // Stay anchored at the bottom
    popupWindow.style.transform = 'translateY(0)'; // No movement
});

let errorAttempts = 0;

document.getElementById('run-code').addEventListener('click', async function () {
    // Remove any previous markers (if desired on every run)
    clearAllErrorHighlights();

    const code = codeEditor.getValue();
    const formData = new FormData();

    // FIXED: Ensure the correct page context is included
    const pageContexts = {
        "/Fetch-Reach-Robot": "Fetch Reach",
        "/PickAndPlacePage": "Pick and Place",
        "/FetchStackPage": "Fetch Stack",
        "/FetchOrganizePage": "Fetch Organize",
        "/FetchOrganizeSensorsPage": "Fetch Sensors",
        "/CarPage": "Car",
    };

    const currentPath = window.location.pathname;
    const pageContext = pageContexts[currentPath] || "General";

    console.log("Current Path:", currentPath);
    console.log("Resolved Page Context:", pageContext);

    // Append BOTH code and page context
    formData.append('code', code);
    formData.append('context', pageContext);

    const outputCard = document.querySelector('.output-card');
    const secondaryOutputCard = document.getElementById('secondary-output-box'); // Secondary output box
    const additionalTabContent = document.getElementById('popup-window-additional-tab'); // Additional tab content

    // Hide the output terminal and secondary box initially
    outputCard.classList.remove('visible');
    secondaryOutputCard.classList.remove('secondary-output-visible', 'success', 'error');
    secondaryOutputCard.classList.add('secondary-output-hidden');

    try {
        const response = await fetch('/run-code', {
            method: 'POST',
            body: formData,
        });

        const data = await response.json();
        const outputBox = document.getElementById('output-box');
        const hintboxContainer = document.getElementById('hintbox-container');
        const hintBox = document.getElementById('hintbox');

        // Clear previous outputs
        outputBox.innerHTML = '';
        secondaryOutputCard.innerHTML = '';

        console.log('🚀 Server response:', data);

        // Show the output terminal and secondary box after processing the response
        outputCard.classList.add('visible');
        secondaryOutputCard.classList.remove('secondary-output-hidden');
        secondaryOutputCard.classList.add('secondary-output-visible');

        if (data.error || (data.static_issues && data.static_issues.length > 0)) {
            // An error occurred – increment our counter
            errorAttempts++;

            // Set red outline for errors
            secondaryOutputCard.classList.add('error');
            secondaryOutputCard.innerHTML = `<p>Your code ran into problems 😢</p>`;

            let popupMessage = '';
            let hintMessage = '';
            let additionalTabHintMessage = '';

            // Extract error details
            let errorLine = null;
            let errorMessage = '';

            if (data.error) {
                outputBox.innerHTML += `<p class="error">Error: ${data.error}</p>`;
                popupMessage += `Error: ${data.error}<br>`;

                hintMessage = data.errorHint || 'No specific hints available for this error.';
                console.log('Hint Message:', data.errorHint);
                additionalTabHintMessage = hintMessage;
                console.log('Additional Tab Hint Message:', additionalTabHintMessage);

                errorLine = extractLineNumberFromError(data.error);
                errorMessage = data.error;

                if (errorLine !== null) {
                    highlightErrorLine(errorLine - 1);
                }
            }

            if (data.static_issues && data.static_issues.length > 0) {
                outputBox.innerHTML += `<p style="color: orange;">Static Issues:</p><ul>`;
                popupMessage += 'Your code has static issues:<br>';
                data.static_issues.forEach(issue => {
                    const issueLine = issue.line;
                    const issueMessage = issue.message;

                    outputBox.innerHTML += `<li>Line ${issueLine}: ${issueMessage}</li>`;
                    popupMessage += `Line ${issueLine}: ${issueMessage}<br>`;

                    if (issue.hint) {
                        hintMessage += `<br>Hint for Line ${issueLine}: ${issue.hint}`;
                        console.log('Static Issue Hint:', issue.hint);
                    }

                    if (typeof issueLine === 'number') {
                        highlightErrorLineStaticIssue(issueLine - 1);
                    }

                    if (errorLine === null) {
                        errorLine = issue.line;
                        errorMessage = issue.message;
                    }
                });
                outputBox.innerHTML += `</ul>`;
            }

            showPopup(popupMessage, true);

            if (errorLine !== null && errorMessage) {
                const errorTracker = JSON.parse(sessionStorage.getItem('errorTracker') || '{}');
                const errorKey = `${errorLine}-${errorMessage}`;
                const hintLevel = errorTracker[errorKey]?.hintLevel || 1;

                const hints = await fetchHints({
                    code: code,
                    errorLine: errorLine,
                    errorMessage: errorMessage,
                    pageContext: pageContext,
                    hintLevel: hintLevel
                });

                if (hints.length > 0) {
                    const hintCount = parseInt(sessionStorage.getItem('hintCount') || '0', 10);
                    const newHintCount = hintCount + 1;
                    sessionStorage.setItem('hintCount', newHintCount.toString());

                    errorTracker[errorKey] = {
                        hintLevel: hintLevel + 1,
                        lastUpdated: Date.now(),
                    };
                    sessionStorage.setItem('errorTracker', JSON.stringify(errorTracker));

                    console.log(`Hint count updated: ${newHintCount}`);
                    console.log(`Hint level for '${errorKey}' is now ${hintLevel + 1}`);
                }

                populateDropdownMenu(hints);
                updateAdditionalTab(hints);
            } else {
                updateAdditionalTab([]);
            }
        } else {
            // SUCCESS branch: code ran successfully
            // Show the success message in the secondary output area.
            secondaryOutputCard.classList.add('success');
            secondaryOutputCard.innerHTML = `<p>Your code ran successfully 😊</p>`;
            outputBox.innerHTML += `<p>${data.message}</p>`;

            const certPopup = document.getElementById('core-certificate-popup');
                if (certPopup) {
                    certPopup.classList.remove('core-cert-popup-hidden');
                    certPopup.classList.add('core-cert-popup-visible');

                    confetti({
                        particleCount: 150,
                        spread: 100,
                        origin: { y: 0.6 }
                    });

                }

            // If there were previous error attempts, then assume the user fixed the errors.
            // In that case, we clear/hide error-specific UI elements while keeping the success message.
            if (errorAttempts > 0) {
                // Clear the detailed output box and hide the output card (which held error details)
                outputBox.innerHTML = '';
                outputCard.classList.remove('visible');

                // Clear error highlights.
                clearAllErrorHighlights();

                // Hide the popup window (if it exists)
                const popupWindow = document.getElementById('popup-window');
                if (popupWindow) {
                    popupWindow.style.display = 'none';
                }

                // Hide the hint container and dropdown.
                hintboxContainer.style.display = 'none';
                const hintsDropdown = document.getElementById('hints-dropdown');
                if (hintsDropdown) {
                    hintsDropdown.style.display = 'none';
                }

                // Note: We no longer hide the secondary output box so that the success message remains visible.
                errorAttempts = 0;
            } else {
                // If no error attempts were recorded, simply hide the hint UI.
                hintboxContainer.style.display = 'none';
                const hintsDropdown = document.getElementById('hints-dropdown');
                if (hintsDropdown) {
                    hintsDropdown.style.display = 'none';
                }
            }

            updateAdditionalTab([]);
        }
    } catch (error) {
        console.error('Error running code:', error);
        outputCard.classList.add('visible');
        secondaryOutputCard.classList.remove('secondary-output-hidden');
        secondaryOutputCard.classList.add('secondary-output-visible', 'error');
        secondaryOutputCard.innerHTML = `<p>Code ran into problems</p>`;

        showPopup('Code ran into problems 😢<br>Unable to run code. Please try again.', true);
        const outputBox = document.getElementById('output-box');
        outputBox.innerHTML = `<p class="error">Error: Unable to run code. Please try again.</p>`;
        updateAdditionalTab(['Unable to run code. Please check your connection and try again.']);
    }
});


// Function to populate the dropdown menu with hints
function populateDropdownMenu(hints) {
    const dropdownMenu = document.getElementById('hints-dropdown');
    const hintBoxContainer = document.getElementById('hintbox-container');
    const hintBox = document.getElementById('hintbox');
    const randomBox = document.getElementById('random-box'); // The Customized Hints tab box

    dropdownMenu.innerHTML = ''; 
    const closeButton = document.createElement('button');
    closeButton.className = 'dropdown-close';
    closeButton.textContent = 'X';
    closeButton.style.cssText = 'float: right; background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: red;';
    closeButton.addEventListener('click', () => {
        dropdownMenu.style.display = 'none';
        hintBoxContainer.style.display = 'none'; 
    });

    dropdownMenu.appendChild(closeButton);

    if (hints.length > 0) {
        hints.forEach((hint, index) => {
            const listItem = document.createElement('li');
            const button = document.createElement('button');
            button.className = 'dropdown-item';
            button.dataset.hint = index + 1;
            button.textContent = `Get Hint ${index + 1}`;
            listItem.appendChild(button);
            dropdownMenu.appendChild(listItem);
        });

        // Automatically select and display the first hint
        updateHintBox([hints[0]]);
    } else {
        const noHintsItem = document.createElement('li');
        noHintsItem.textContent = 'No hints available';
        dropdownMenu.appendChild(noHintsItem);
    }

    dropdownMenu.style.display = 'block'; // Ensure dropdown is visible
}

// Event listener for dropdown menu clicks (if still needed)
document.getElementById('hints-dropdown').addEventListener('click', (event) => {
    if (event.target.classList.contains('dropdown-item')) {
        const hintIndex = parseInt(event.target.dataset.hint, 10) - 1;
        if (currentHints && currentHints[hintIndex]) {
            updateHintBox([currentHints[hintIndex]]);
        }
    }
});

// Function to update the hint box
function updateHintBox(hintMessages) {
    const hintBox = document.getElementById('hintbox');
    const hintBoxContainer = document.getElementById('hintbox-container');

    hintBox.innerHTML = '';
    if (hintMessages && hintMessages.length > 0) {
        hintMessages.forEach((hint, index) => {
            const hintItem = document.createElement('li');
            hintItem.textContent = `${index + 1}. ${hint}`;
            hintBox.appendChild(hintItem);
        });
        hintBoxContainer.style.display = 'block';
    } else {
        hintBoxContainer.style.display = 'none';
    }
}

function updateAdditionalTab(newHints) {
    const hintsHistoryContent = document.getElementById('hints-history-content');

    // If newHints is not an array, convert it into one
    if (!Array.isArray(newHints)) {
        newHints = [newHints];
    }

    // Append new hints to the global hintsHistory array
    hintsHistory.push(...newHints);

    // Save the updated hintsHistory to localStorage (if implementing persistence)
    localStorage.setItem('hintsHistory', JSON.stringify(hintsHistory));

    // Clear existing content
    hintsHistoryContent.innerHTML = '';

    if (hintsHistory.length > 0) {
        // Create an unordered list to display all hints
        const hintList = document.createElement('ul');

        hintsHistory.forEach((hint, index) => {
            const listItem = document.createElement('li');
            listItem.textContent = `${index + 1}. ${hint}`;
            hintList.appendChild(listItem);
        });

        hintsHistoryContent.appendChild(hintList);
    } else {
        // Display a default message if there are no hints
        hintsHistoryContent.innerHTML = '<p>No specific hints available.</p>';
    }
}

// Function to clear hints history
function clearHintsHistory() {
    hintsHistory = []; // Reset the global hintsHistory array
    localStorage.removeItem('hintsHistory'); // Remove from localStorage
    updateAdditionalTab([]); // Update the Additional Tab to show default message
}

// Add event listener to the "Clear History" button
document.getElementById('clear-hints-history').addEventListener('click', () => {
    if (confirm('Are you sure you want to clear the hints history?')) {
        clearHintsHistory();
    }
});


    window.addEventListener('load', updatePositions);

    // CODING PETS
    const codingPetsButton = document.getElementById('coding-pets');
    const editorElement = document.querySelector('.code-editor');

    let isPetEnabled = false;
    let petMoving = false;
    let codingPetContainer;
    let petIntervalId = null;
    let currentPet = 'chicken';
    let gifChangeIntervalId = null;

    function createPet() {
        const existingPet = document.getElementById('coding-pet-container');
        if (existingPet) {
            existingPet.remove();
        }

        const codingPetContainer = document.createElement('div');
        codingPetContainer.id = 'coding-pet-container';
        codingPetContainer.classList.add('pet-container');

        const petImage = document.createElement('img');
        petImage.id = 'coding-pet';
        petImage.alt = "coding-pet";

        const petGifs = {
            chicken: [
                "{{ url_for('static', filename='img/pets/chicken/white_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/chicken/white_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/chicken/white_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/chicken/white_swipe_8fps.gif') }}"
            ],
            dog: [
                "{{ url_for('static', filename='img/pets/dog/black_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dog/black_lie_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dog/black_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dog/black_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dog/black_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dog/black_with_ball_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dog/black_walk_fast_8fps.gif') }}",
            ],
            turtle: [
                "{{ url_for('static', filename='img/pets/turtle/green_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/turtle/green_lie_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/turtle/green_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/turtle/green_walk_8fps.gif') }}",
            ],
            snail: [
                "{{ url_for('static', filename='img/pets/snail/brown_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snail/brown_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snail/brown_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snail/brown_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snail/brown_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snail/brown_with_ball_8fps.gif') }}",
            ],
            rubberduck: [
                "{{ url_for('static', filename='img/pets/duck/yellow_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/duck/yellow_swipe_8fps.gif') }}",
            ],
            rock: [
                "{{ url_for('static', filename='img/pets/rock/gray_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rock/gray_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rock/gray_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rock/gray_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rock/gray_walk_fast_8fps.gif') }}"
            ],
            rat: [
                "{{ url_for('static', filename='img/pets/rat/brown_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rat/brown_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rat/brown_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rat/brown_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/rat/brown_with_ball_8fps.gif') }}"
            ],
            unicorn: [
                "{{ url_for('static', filename='img/pets/unicorn/magical_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/unicorn/magical_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/unicorn/magical_stand_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/unicorn/magical_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/unicorn/magical_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/unicorn/magical_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/unicorn/magical_with_ball_8fps.gif') }}"
            ],
            fox: [
                "{{ url_for('static', filename='img/pets/fox/red_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/fox/red_lie_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/fox/red_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/fox/red_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/fox/red_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/fox/red_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/fox/red_with_ball_8fps.gif') }}"
            ],
            dinosaur: [
                "{{ url_for('static', filename='img/pets/dinosaur/green_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dinosaur/green_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dinosaur/green_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dinosaur/green_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dinosaur/green_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/dinosaur/green_with_ball_8fps.gif') }}"
            ],
            crab: [
                "{{ url_for('static', filename='img/pets/crab/red_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/crab/red_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/crab/red_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/crab/red_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/crab/red_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/crab/red_with_ball_8fps.gif') }}"
            ],
            snake: [
                "{{ url_for('static', filename='img/pets/snake/green_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snake/green_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snake/green_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snake/green_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/snake/green_with_ball_8fps.gif') }}"
            ],
            horse: [
                "{{ url_for('static', filename='img/pets/horse/socks_brown_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/horse/socks_brown_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/horse/socks_brown_stand_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/horse/socks_brown_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/horse/socks_brown_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/horse/socks_brown_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/horse/socks_brown_with_ball_8fps.gif') }}"
            ],
            bird: [
                "{{ url_for('static', filename='img/pets/bird/gray_idle_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/bird/gray_run_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/bird/gray_swipe_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/bird/gray_walk_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/bird/gray_walk_fast_8fps.gif') }}",
                "{{ url_for('static', filename='img/pets/bird/gray_with_ball_8fps.gif') }}"
            ]

        };

        const defaultGif = petGifs[currentPet][0];
        petImage.src = defaultGif;

        codingPetContainer.appendChild(petImage);

        const editorArea = document.querySelector('.code-editor');
        editorArea.appendChild(codingPetContainer);

        const editorRect = editorArea.getBoundingClientRect();
        const petHeight = 50;
        const lineNumberWidth = 40;

        const bottomY = editorRect.height - petHeight - 165; // Need to adjust this value for different device sizes
        const initialLeftX = lineNumberWidth + 10 + 20; // Need to adjust this value for different device sizes

        codingPetContainer.style.transform = `translate(${initialLeftX}px, ${bottomY}px)`;

        const maxDistance = 600;
        let add = 0;
        let direction = 1;
        let currentGifIndex = 0;
        let isPaused = false; 
        const pauseDuration = 2000; 

        if (currentPet === 'rock') {
            if (gifChangeIntervalId) {
                clearInterval(gifChangeIntervalId);
            }
            gifChangeIntervalId = setInterval(() => {
                const selectedGifs = petGifs.rock;
                currentGifIndex = (currentGifIndex + 1) % selectedGifs.length;
                petImage.src = selectedGifs[currentGifIndex];
            }, 3000); 
            return; 
        }

        if (petIntervalId) {
            clearInterval(petIntervalId);
        }

        petIntervalId = setInterval(() => {
            if (isPaused) {
                return; 
            }

            const idleGifsToSkip = [
                'red_idle_8fps.gif',
                'white_idle_8fps.gif',
                'white_swipe_8fps.gif',
                'gray_idle_8fps.gif',
                'gray_swipe_8fps.gif',
                'gray_with_ball_8fps.gif',
                'green_idle_8fps.gif',
                'green_lie_8fps.gif',
                'green_swipe_8fps.gif',
                'green_with_ball_8fps.gif',
                'black_idle_8fps.gif',
                'black_lie_8fps.gif',
                'black_with_ball_8fps.gif',
                'black_swipe_8fps.gif',
                'red_idle_8fps.gif',
                'red_lie_8fps.gif',
                'red_swipe_8fps.gif',
                'red_with_ball_8fps.gif',
                'socks_brown_idle_8fps.gif',
                'socks_brown_stand_8fps.gif',
                'socks_brown_swipe_8fps.gif',
                'socks_brown_with_ball_8fps.gif',
                'brown_idle_8fps.gif',
                'brown_with_ball_8fps.gif',
                'brown_swipe_8fps.gif',
                'magical_idle_8fps.gif',
                'magical_swipe_8fps.gif',
                'magical_with_ball_8fps.gif',
                'magical_stand_8fps.gif',
                'yellow_swipe_8fps.gif'
            ];

            if (idleGifsToSkip.some(idleGif => petImage.src.includes(idleGif))) {
                return;
            }
            add += 10 * direction;

            const shouldPause = Math.random() < 0.1; 
            if (shouldPause) {
                isPaused = true;
                setTimeout(() => {
                    isPaused = false; 
                }, pauseDuration);
            }

            if (add >= maxDistance) {
                direction = -1;
                petImage.classList.add('flipped');
            } else if (add <= 0) {
                direction = 1;
                petImage.classList.remove('flipped'); 
            }

            codingPetContainer.style.transform = `translate(${initialLeftX + add}px, ${bottomY}px)`;
        }, 1000); 

        if (gifChangeIntervalId) {
            clearInterval(gifChangeIntervalId);
        }

        gifChangeIntervalId = setInterval(() => {
            const selectedGifs = petGifs[currentPet];
            currentGifIndex = (currentGifIndex + 1) % selectedGifs.length;
            petImage.src = selectedGifs[currentGifIndex];
        }, 3000);
    }

    const disablePetOption = document.getElementById("disable-pet");

    const petOptions = document.querySelectorAll(".pet-option");
    petOptions.forEach(option => {
        option.addEventListener("click", (event) => {
            event.preventDefault(); 

            const petType = option.getAttribute("pet-type");
            currentPet = petType; 
            createPet(); 
            disablePetOption.style.display = "block";
        });
    });


    disablePetOption.addEventListener("click", (event) => {
        event.preventDefault(); 

        if (petIntervalId) {
            clearInterval(petIntervalId);
            petIntervalId = null;
        }
        if (gifChangeIntervalId) {
            clearInterval(gifChangeIntervalId);
            gifChangeIntervalId = null;
        }

        const existingPet = document.getElementById("coding-pet-container");
        if (existingPet) {
            existingPet.remove();
        }

        currentPet = null;
        
        disablePetOption.style.display = "none";

        alert("Pet has been disabled!");
    });


    // LIGHT MODE
    const darkModeThemes = [
        { name: "Monokai", value: "monokai" },
        { name: "Dracula", value: "dracula" },
        { name: "Material", value: "material" },
        { name: "Ambiance", value: "ambiance" },
        { name: "Cobalt", value: "cobalt" },
        { name: "Twilight", value: "twilight" },
        { name: "Solarized Dark", value: "solarized dark" },
        { name: "Midnight", value: "midnight" },
        { name: "Lucario", value: "lucario" },
        { name: "Seti", value: "seti" },
        { name: "Blackboard", value: "blackboard" },
        { name: "Zenburn", value: "zenburn" },
    ];

    const lightModeThemes = [
        { name: "Default", value: "default" },
        { name: "Solarized Light", value: "solarized light" },
        { name: "Eclipse", value: "eclipse" },
        { name: "Base16 Light", value: "base16-light" },
        { name: "XQ Light", value: "xq-light" },
        { name: "Idea", value: "idea" },
        { name: "Neo", value: "neo" },
        { name: "Elegant", value: "elegant" },
    ];

    function updateThemeOptions(isLightMode) {
        const themeOptions = isLightMode ? lightModeThemes : darkModeThemes;
        const dropdownMenu = document.querySelector("#syntax-highlight + .dropdown-menu");
        dropdownMenu.innerHTML = ""; 

        themeOptions.forEach(theme => {
            const listItem = document.createElement("li");
            const anchor = document.createElement("a");
            anchor.href = "#";
            anchor.classList.add("dropdown-item", "theme-option");
            anchor.setAttribute("data-theme", theme.value);
            anchor.textContent = theme.name;

            listItem.appendChild(anchor);
            dropdownMenu.appendChild(listItem);

            anchor.addEventListener("click", function (event) {
                event.preventDefault();
                currentTheme = theme.value;
                codeEditor.setOption("theme", currentTheme);
                alert(`Syntax Highlighting changed to ${theme.name}`);
            });
        });
    }

    const lightModeButton = document.getElementById("light-mode");
    const roboticEnvironment = document.querySelector(".robotic-environment");

    lightModeButton.addEventListener("click", () => {
        roboticEnvironment.classList.toggle("light-mode");

        console.log("Light mode toggled:", roboticEnvironment.classList.contains("light-mode"));
        console.log("Current classes:", roboticEnvironment.className);

        const isLightMode = roboticEnvironment.classList.contains("light-mode");

        const codeMirrorInstance = document.querySelector(".CodeMirror");
        if (codeMirrorInstance) {
            const theme = isLightMode ? "3024-day" : "monokai";
            codeEditor.setOption("theme", theme); 
            console.log(`CodeMirror theme set to: ${theme}`);
        }

        if (lightModeButton._tippy) {
            lightModeButton._tippy.setContent(isLightMode ? "Switch to Dark Mode" : "Switch to Light Mode");
        }
        
        updateThemeOptions(isLightMode); 
        alert(isLightMode ? "Light Mode Enabled!" : "Dark Mode Enabled!");
    });

    // SYNTAX HIGHLIGHTING
    document.querySelectorAll('.theme-option').forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault(); 
            const selectedTheme = this.getAttribute('data-theme'); 

            if (selectedTheme) {
                currentTheme = selectedTheme; 
                codeEditor.setOption("theme", currentTheme); 
                alert(`Syntax Highlighting changed to ${currentTheme}`);
            }
        });
    });

    document.getElementById("syntax-highlight").addEventListener("click", toggleSyntaxHighlighting);

</script>
{% endblock %}
