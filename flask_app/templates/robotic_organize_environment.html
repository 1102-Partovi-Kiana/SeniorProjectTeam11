{% extends "base.html" %}


{% block title %}
<title>Fetch Pick and Place Environment</title>
{% endblock %}


{% block body %}
<section>
    <div class="container-fluid">
        <div class="row d-flex">
            <!-- Code editor on the left -->
            <div class="col-md-6" style="margin-top: 200px;">
                <div class="code-editor">
                    <h4>Python Code Editor</h4>
                    <textarea id="code-editor" rows="20">
def handle_object(current_env, object_name, target_color, container_position):
    close_grip_action = np.array([0, 0, 0, -1])
    open_grip_action = np.array([0, 0, 0, 1])
    box_to_ball_threshold = 0.03  # Threshold for object proximity to container
    env.step(open_grip_action)
    # Step 1: Move gripper horizontally to the object
    while True:
        object_position = env.sim.data.get_site_xpos(object_name)
        gripper_position = env.sim.data.get_site_xpos('robot0:grip')


        horizontal_distance = np.linalg.norm(object_position[:2] - gripper_position[:2])


        if horizontal_distance <= 0.01:
            break


        direction = object_position - gripper_position
        direction_normalized = direction / (np.linalg.norm(direction[:2]) + 1e-8)


        horizontal_action = np.array([
            direction_normalized[0] * 0.1,
            direction_normalized[1] * 0.1,
            0,
            0
        ])
        env.step(horizontal_action)


    # Step 2: Move gripper vertically to align with the object
    while True:
        gripper_position = env.sim.data.get_site_xpos('robot0:grip')
        vertical_distance = object_position[2] - gripper_position[2]
        if abs(vertical_distance) <= 0.01:
            break


        descend_action = np.array([0, 0, vertical_distance * 0.1, 0])
        env.step(descend_action)


    # Step 3: Close grip on the object
    env.step(close_grip_action)


    # Step 4: Check if gripper is in contact and the object's color
    geom_id = env.sim.model.geom_name2id(object_name)
    rgba = env.sim.model.geom_rgba[geom_id]
    color = rgba[:3]


    if np.array_equal(color, target_color):  # Exact match comparison
        print(f"Target color detected for {object_name}. Moving to container...")


        # Step 5: Lift the object
        for _ in range(40):
            env.step(close_grip_action)
            ascend_action = np.array([0, 0, 0.13, 0])
            env.step(ascend_action)


        # Step 6: Move the object to the container
        for _ in range(100):  # Adjust step count as needed
            gripper_position = env.sim.data.get_site_xpos('robot0:grip')
            object_position = env.sim.data.get_site_xpos(object_name)
            env.step(close_grip_action)


            distance_to_box = np.linalg.norm(container_position - object_position)
            if distance_to_box <= box_to_ball_threshold:
                break


            direction_to_container = container_position - gripper_position
            direction_normalized = direction_to_container / (np.linalg.norm(direction_to_container) + 1e-8)


            move_to_container_action = np.array([
                direction_normalized[0] * 0.5,
                direction_normalized[1] * 0.5,
                0,
                0
            ])
            env.step(move_to_container_action)


        # Step 7: Release the object
        env.step(open_grip_action)
        for _ in range(10):
            env.step([0, 0, 0, 0])


    else:
        env.step(open_grip_action)
        for _ in range(40):
            ascend_action = np.array([0, 0, 0.13, 0])
            env.step(ascend_action)
       
# Example usage
target_color = np.array([0.5, 0.5, 0.5])
container_position = np.array([1.3, 0.2, 0.54])
handle_object(env, 'object0', target_color, container_position)
handle_object(env, 'object1', target_color, container_position)
handle_object(env, 'object2', target_color, container_position)
handle_object(env, 'object3', target_color, container_position)
                    </textarea>
                </div>
            </div>


            <!-- Video player on the right -->
            <div class="col-md-6 d-flex justify-content-center align-items-center" style="margin-top: 200px;">
                <div class="video-container">
                    <img src="{{ url_for('video_feed') }}" width="90%">
                </div>
            </div>
        </div>
       
        <!-- Collision notification -->
        <div id="collision-notification" class="alert alert-success" style="display: none; margin-top: 20px;">
            Collision detected between the gripper and the object!
        </div>
       
        <!-- Display positions -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h5>Ball Position:</h5>
                <p id="ball-position">X: --, Y: --, Z: --</p>
                <h5>Gripper Position:</h5>
                <p id="gripper-position">X: --, Y: --, Z: --</p>
            </div>
            <div class="col-md-6 text-right">
                <button id="run-code" class="btn btn-success">Run</button>
            </div>
        </div>
       
        <div class="col-md-6" style="margin-top: 20px;">
            <h4>Output</h4>
            <div id="output-box" style="border: 1px solid #ddd; padding: 10px; height: 150px; overflow-y: auto;">
                <!-- Output will appear here -->
            </div>
        </div>        
    </div>
</section>


<script>
    function updatePositions() {
        fetch('/get-ball-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ball-position').textContent =
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
        fetch('/get-gripper-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('gripper-position').textContent =
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
    }


    function checkCollision() {
        fetch('/check-collision')
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('collision-notification');
                if (data.collision) {
                    notification.style.display = 'block';
                } else {
                    notification.style.display = 'none';
                }
            })
            .catch(error => console.error('Error checking collision:', error));
    }


    document.getElementById('run-code').addEventListener('click', function() {
        const code = document.getElementById('code-editor').value;


        const formData = new FormData();
        formData.append('code', code);


        fetch('/run-code', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            const outputBox = document.getElementById('output-box');
            outputBox.innerHTML = '';
            if (data.error) {
                outputBox.innerHTML += `<p style="color: red;">Error: ${data.error}</p>`;
            } else {
                outputBox.innerHTML += `<p>${data.message}</p>`;
                document.getElementById('ball-position').textContent =
                    `X: ${data.ball_position.x.toFixed(2)}, Y: ${data.ball_position.y.toFixed(2)}, Z: ${data.ball_position.z.toFixed(2)}`;
                document.getElementById('gripper-position').textContent =
                    `X: ${data.gripper_position.x.toFixed(2)}, Y: ${data.gripper_position.y.toFixed(2)}, Z: ${data.gripper_position.z.toFixed(2)}`;
               
                checkCollision();
            }
        })
        .catch(error => {
            console.error('Error running code:', error);
        });
    });


    window.addEventListener('load', updatePositions);
</script>


{% endblock %}



