{% extends "base.html" %}

{% block title %}
<title>Robotic Environment</title>
{% endblock %}

{% block body %}
<section class="robotic-environment">
    <!-- Preload Pets -->
    <div style="display: none;">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_run_8fps.gif') }}" alt="Run">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_swipe_8fps.gif') }}" alt="Swipe">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_walk_8fps.gif') }}" alt="Walk1">
        <img src="{{ url_for('static', filename='img/pets/chicken/white_walk_fast_8fps.gif') }}" alt="Walk2">
    </div>
    <div class="container-fluid content-background">
        <div class="row" style="min-height: 100vh; padding-top: 10px;">
            <!-- Coding Area and Simulation Side by Side -->
            <div class="col-md-6 d-flex flex-column">
                <div class="code-editor h-100">
                     <!-- Tab Buttons Above the Coding Area -->
                     <div class="coding-options">
                        <button class="tab-button" id="coding-pets" data-tippy-content="Enable Coding Pets">
                            <i class="fas fa-paw"></i> 
                        </button>
                        <button class="tab-button" id="light-mode" data-tippy-content="Switch to Light Mode">
                            <i class="fas fa-sun"></i> 
                        </button>
                        <div class="dropdown-container">
                            <button class="tab-button" id="syntax-highlight" data-tippy-content="Change Syntax Highlighting Color">
                                <i class="fas fa-palette"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a href="#" class="dropdown-item theme-option" data-theme="monokai">Monokai</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="dracula">Dracula</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="material">Material</a></li>
                                <li><a href="#" class="dropdown-item theme-option" data-theme="ambiance">Ambiance</a></li>
                            </ul>
                        </div>
                        <button class="tab-button" id="autocomplete" data-tippy-content="Enable Autocomplete">
                            <i class="fas fa-magic"></i> 
                        </button>
                    </div>                    
                    <div class="card-header">Coding Area</div>
                    <textarea id="code-editor" rows="20" style="height: 100%;">
# Sample pre-rendered code for the robotics environment
ball_position = env.get_ball_position()
gripper_position = env.get_gripper_position()
direction = np.array(ball_position) - np.array(gripper_position)
distance_threshold = 0.01
step_size = 0.05

while np.linalg.norm(direction) > distance_threshold:
    action = np.append(direction / np.linalg.norm(direction) * step_size, [1])
    env.step(action)
    gripper_position = env.get_gripper_position()
    direction = np.array(ball_position) - np.array(gripper_position)

print("Final Gripper Position:", gripper_position)
print("Reached near the ball.")
                    </textarea>
                    <div class="col-md-4 d-flex justify-content-end">
                        <button id="run-code" class="aesthetic-green-button-dark">Run</button>
                    </div>

                    <!-- Ball and Gripper Position -->
                    <div class="row align-items-start" style="margin-top: 5px;">
                        <div class="col-md-8">
                            <h5>Ball Position:</h5>
                            <p id="ball-position">X: --, Y: --, Z: --</p>
                            <h5>Gripper Position:</h5>
                            <p id="gripper-position">X: --, Y: --, Z: --</p>
                        </div>
                    </div>

                    <!-- Collision Notification -->
                    <div id="collision-notification" class="alert alert-success" style="margin-top: 5px; display: none;">
                        Collision detected between the gripper and the ball!
                    </div>
                </div>
            </div>

            <div class="chatbot-container">
                <div id="chatbox" class="chatbox"></div>
                <div class="chat-input-container">
                    <input type="text" id="userInput" placeholder="Type a message">
                    <button id="sendBtn">Send</button>
                </div>
            </div>
            
               

            <div class="col-md-6 d-flex flex-column">
                <div class="card simulation-card h-80">
                    <div class="card-header">Simulation</div>
                    <div class="d-flex justify-content-center align-items-center">
                        <img src="{{ url_for('video_feed') }}" width="100%" class="simulation-video">
                    </div>
                </div>

                <!-- Output Terminal - Placed Below Simulation -->
                <div class="card output-card">
                    <div class="card-header">Output Terminal</div>
                    <div class="card-body" id="output-box">
                        <!-- Output will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CodeMirror and Script Initialization -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css" rel="stylesheet">
<!-- Dracula Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css" rel="stylesheet">
<!-- Other Themes -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ambiance.min.css" rel="stylesheet">


<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>

<script>
    let currentTheme = "monokai"; // The initial theme
    let isAutocompleteEnabled = false; // Flag for autocomplete state

    // Initialize CodeMirror
    const codeEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        lineNumbers: true,
        mode: "python",
        theme: currentTheme,
        tabSize: 4,
        indentUnit: 4,
        autoCloseBrackets: true,
        viewportMargin: Infinity
    });

    const MIN_LINE_COUNT = 100;
    function ensureMinLines() {
        const lineCount = codeEditor.lineCount();
        for (let i = lineCount; i < MIN_LINE_COUNT; i++) {
            codeEditor.replaceRange("\n", CodeMirror.Pos(i));
        }
    }
    ensureMinLines();

    codeEditor.setSize("100%", "calc(80vh - 100px)");

    // AUTOCOMPLETE
    function inputReadHandler(editor, change) {
        if (change.text[0] !== " ") {
            console.log("Input detected:", change.text[0]);
            editor.showHint({ hint: CodeMirror.hint.python });
        }
    }

    async function enableAutocomplete() {
        console.log("Enabling autocomplete...");

        CodeMirror.registerHelper("hint", "python", async function (editor) {
            const cursor = editor.getCursor();
            const code = editor.getValue();
            const line = cursor.line + 1; 
            const column = cursor.ch;

            try {
                const response = await fetch('/get-suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code, line, column }),
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch suggestions');
                }

                const suggestions = await response.json();
                console.log("Combined Suggestions:", suggestions);

                const token = editor.getTokenAt(cursor);
                const word = token.string;
                const start = token.start;
                const end = token.end;

                const filteredSuggestions = suggestions.filter(keyword =>
                    keyword.startsWith(word)
                );

                return {
                    list: filteredSuggestions,
                    from: CodeMirror.Pos(cursor.line, start),
                    to: CodeMirror.Pos(cursor.line, end),
                };
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                return {
                    list: [],
                    from: CodeMirror.Pos(cursor.line, cursor.ch),
                    to: CodeMirror.Pos(cursor.line, cursor.ch),
                };
            }
        });

        codeEditor.setOption("extraKeys", {
            "Ctrl-Space": "autocomplete"
        });

        codeEditor.on("inputRead", inputReadHandler);

        alert("Autocomplete enabled!");
    }

    function disableAutocomplete() {
        console.log("Disabling autocomplete...");
        
        codeEditor.setOption("extraKeys", {});
        codeEditor.off("inputRead", inputReadHandler);

        alert("Autocomplete disabled!");
    }


    document.getElementById("autocomplete").addEventListener("click", function() {
        if (!isAutocompleteEnabled) {
            enableAutocomplete();
        } else {
            disableAutocomplete();
        }
        isAutocompleteEnabled = !isAutocompleteEnabled; // Toggle the flag
    });

    // CODING PETS
    const codingPetsButton = document.getElementById('coding-pets');
    const editorElement = document.querySelector('.code-editor');

    let isPetEnabled = false;
    let petMoving = false;
    let codingPetContainer;

    const petAnimations = [
        "{{ url_for('static', filename='img/pets/chicken/white_walk_8fps.gif') }}",
        "{{ url_for('static', filename='img/pets/chicken/white_walk_fast_8fps.gif') }}",
        "{{ url_for('static', filename='img/pets/chicken/white_run_8fps.gif') }}",
        "{{ url_for('static', filename='img/pets/chicken/white_swipe_8fps.gif') }}"
    ];

    function createPet() {
        codingPetContainer = document.createElement('div');
        codingPetContainer.id = 'coding-pet-container';
        codingPetContainer.classList.add('pet-container');

        const petImage = document.createElement('img');
        petImage.id = 'coding-pet';
        petImage.src = "{{ url_for('static', filename='img/pets/chicken/white_idle_8fps.gif') }}";
        petImage.alt = "coding-pet";

        codingPetContainer.appendChild(petImage);

        const editorArea = document.querySelector('.code-editor');
        editorArea.appendChild(codingPetContainer);

        const editorRect = editorArea.getBoundingClientRect();
        const petHeight = 50; 
        const lineNumberWidth = 40; 

        const bottomY = editorRect.height - petHeight - 165; // Move pet up from the bottom
        const leftX = lineNumberWidth + 10 + 20; // Move pet to the right

        codingPetContainer.style.transform = `translate(${leftX}px, ${bottomY}px)`;

        
        let add = 0;
        setInterval(() => {
            add += 20;
            codingPetContainer.style.transform = `translate(${leftX + add}px, ${bottomY}px)`;
        }, 200);
    }

    codingPetsButton.addEventListener('click', () => {
        if (!isPetEnabled) {
            // Enable pet
            isPetEnabled = true;
            createPet();
            alert('Coding pet enabled!');
            editorElement.addEventListener('click', movePetRandomly);
        } else {
            // Disable pet
            isPetEnabled = false;
            if (codingPetContainer) {
                codingPetContainer.remove();
            }
            alert('Coding pet disabled.');
            editorElement.removeEventListener('click', movePetRandomly);
        }
    });

    // SYNTAX HIGHLIGHTING
    console.log(CodeMirror.hint);
    function toggleSyntaxHighlighting() {
        if (currentTheme === "monokai") {
            currentTheme = "dracula";
            codeEditor.setOption("theme", "dracula");
        } else {
            currentTheme = "monokai";
            codeEditor.setOption("theme", "monokai");
        }
        alert(`Syntax Highlighting changed to ${currentTheme}`);
    }

    document.getElementById("syntax-highlight").addEventListener("click", toggleSyntaxHighlighting);

    function updatePositions() {
        fetch('/get-ball-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ball-position').textContent = 
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
        fetch('/get-gripper-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('gripper-position').textContent = 
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
    }

    function checkCollision() {
        fetch('/check-collision')
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('collision-notification');
                if (data.collision) {
                    notification.style.display = 'block';
                } else {
                    notification.style.display = 'none';
                }
            })
            .catch(error => console.error('Error checking collision:', error));
    }

    document.getElementById('run-code').addEventListener('click', function() {
        const code = codeEditor.getValue();

        const formData = new FormData();
        formData.append('code', code);

        fetch('/run-code', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            const outputBox = document.getElementById('output-box');
            outputBox.innerHTML = '';
            if (data.error) {
                outputBox.innerHTML += `<p style="color: red;">Error: ${data.error}</p>`;
            } else {
                outputBox.innerHTML += `<p>${data.message}</p>`;
                document.getElementById('ball-position').textContent = 
                    `X: ${data.ball_position.x.toFixed(2)}, Y: ${data.ball_position.y.toFixed(2)}, Z: ${data.ball_position.z.toFixed(2)}`;
                document.getElementById('gripper-position').textContent = 
                    `X: ${data.gripper_position.x.toFixed(2)}, Y: ${data.gripper_position.y.toFixed(2)}, Z: ${data.gripper_position.z.toFixed(2)}`;
                
                checkCollision();
            }
        })
        .catch(error => {
            console.error('Error running code:', error);
        });
    });

    window.addEventListener('load', updatePositions);
</script>
{% endblock %}
