{% extends "base.html" %}

{% block title %}
<title>Fetch Pick and Place Environment</title>
{% endblock %}

{% block body %}
<section>
    <div class="container-fluid">
        <div class="row d-flex">
            <!-- Code editor on the left -->
            <div class="col-md-6" style="margin-top: 200px;">
                <div class="code-editor">
                    <h4>Python Code Editor</h4>
                    <textarea id="code-editor" rows="20">
object_position = current_env.sim.data.get_site_xpos('object0')
gripper_position = current_env.get_gripper_position()

for _ in range(10):
    action = np.array([
        (object_position[0] - gripper_position[0]) * 0.1,  # X
        (object_position[1] - gripper_position[1]) * 0.1,  # Y
        (object_position[2] - gripper_position[2]) * 0.1,   # Z
        0
    ])
    
    current_env.step(action)
    gripper_position = current_env.get_gripper_position()

grip_action = np.array([0, 0, 0, -1])
current_env.step(grip_action)

lift_action = np.array([0, 0, 0.1, 0])
for _ in range(10):
    current_env.step(lift_action)

release_action = np.array([0, 0, 0, 1])
current_env.step(release_action)
                    </textarea>
                </div>
            </div>

            <!-- Video player on the right -->
            <div class="col-md-6 d-flex justify-content-center align-items-center" style="margin-top: 200px;">
                <div class="video-container">
                    <img src="{{ url_for('video_feed') }}" width="100%">
                </div>
            </div>
        </div>
        
        <!-- Collision notification -->
        <div id="collision-notification" class="alert alert-success" style="display: none; margin-top: 20px;">
            Collision detected between the gripper and the object!
        </div>
        
        <!-- Display positions -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h5>Box Position:</h5>
                <p id="box-position">X: --, Y: --, Z: --</p>
                <h5>Gripper Position:</h5>
                <p id="gripper-position">X: --, Y: --, Z: --</p>
            </div>
            <div class="col-md-6 text-right">
                <button id="run-code" class="btn btn-success">Run</button>
            </div>
        </div>
        
        <div class="col-md-6" style="margin-top: 20px;">
            <h4>Output</h4>
            <div id="output-box" style="border: 1px solid #ddd; padding: 10px; height: 150px; overflow-y: auto;">
                <!-- Output will appear here -->
            </div>
        </div>        
    </div>
</section>

<script>
    function updatePositions() {
        fetch('/get-box-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('box-position').textContent = 
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
        fetch('/get-gripper-position')
            .then(response => response.json())
            .then(data => {
                document.getElementById('gripper-position').textContent = 
                    `X: ${data.x.toFixed(2)}, Y: ${data.y.toFixed(2)}, Z: ${data.z.toFixed(2)}`;
            });
    }

    function checkCollision() {
        fetch('/check-collision')
            .then(response => response.json())
            .then(data => {
                const notification = document.getElementById('collision-notification');
                if (data.collision) {
                    notification.style.display = 'block';
                } else {
                    notification.style.display = 'none';
                }
            })
            .catch(error => console.error('Error checking collision:', error));
    }

    document.getElementById('run-code').addEventListener('click', function() {
        const code = document.getElementById('code-editor').value;

        const formData = new FormData();
        formData.append('code', code);

        fetch('/run-code', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            const outputBox = document.getElementById('output-box');
            outputBox.innerHTML = '';
            if (data.error) {
                outputBox.innerHTML += `<p style="color: red;">Error: ${data.error}</p>`;
            } else {
                outputBox.innerHTML += `<p>${data.message}</p>`;
                document.getElementById('box-position').textContent = 
                    `X: ${data.box_position.x.toFixed(2)}, Y: ${data.box_position.y.toFixed(2)}, Z: ${data.box_position.z.toFixed(2)}`;
                document.getElementById('gripper-position').textContent = 
                    `X: ${data.gripper_position.x.toFixed(2)}, Y: ${data.gripper_position.y.toFixed(2)}, Z: ${data.gripper_position.z.toFixed(2)}`;
                
                checkCollision();
            }
        })
        .catch(error => {
            console.error('Error running code:', error);
        });
    });

    window.addEventListener('load', updatePositions);
</script>

{% endblock %}
